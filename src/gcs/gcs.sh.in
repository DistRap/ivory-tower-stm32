#!/bin/bash

HOST=127.0.0.1
PORT=6000
COMMSEC_SERVER=smaccm-gcs-gateway
BIN_DIR=../.cabal-sandbox/bin
MAVPROXY_DIR=../mavlink

EXEC_MAVPROXY="python $MAVPROXY_DIR/mavproxy.py --master=tcp:$HOST:$PORT"

# Parameters from "Keys.mk":
SERVER_ARGS="--senderid=@BASE_ID@ \
      --sendkey=@BASE_KEY@ \
      --sendsalt=@BASE_SALT@ \
      --recvkey=@UAV_KEY@ \
      --recvsalt=@UAV_SALT@"

if [ -n "$DISPLAY" ]; then
	# Try terminal emulators in this order:
	# - x-terminal-emulator (Debian script which works like xterm)
	# - gnome-terminal
	# - xterm
	# Fall back to running in the console if these aren't found.
	TERM_ARGS="-e"
	if [ -z "$TERM_APP" ]; then
		if ! TERM_APP=$(which x-terminal-emulator); then
			if TERM_APP=$(which gnome-terminal); then
				TERM_ARGS="-x"
			else
				TERM_APP=$(which xterm)
			fi
		fi
	fi
fi

while getopts "dvqs:b:hmo:t" opt; do
	echo $opt
	case $opt in
		d)
			SERVER_ARGS="$SERVER_ARGS --debug"
			;;
		v)
			SERVER_ARGS="$SERVER_ARGS --verbose"
			;;
		q)
			SERVER_ARGS="$SERVER_ARGS --quiet"
			;;
		s)
			SERVER_ARGS="$SERVER_ARGS --serial=$OPTARG"
			;;
		b)
			SERVER_ARGS="$SERVER_ARGS --baud=$OPTARG"
			;;
		h)
			EXEC_MAVPROXY="$EXEC_MAVPROXY --sitl 127.0.0.1:5501 --module HIL"
			;;
		m)
			EXEC_MAVPROXY="$EXEC_MAVPROXY --module mavelous"
			;;
		o)
			EXEC_MAVPROXY="$EXEC_MAVPROXY --out=$OPTARG"
			;;
		t)
			# Suppress spinning mavproxy off to a terminal emulator.
			TERM_APP=
			;;
		\?)
			echo "Invalid option: -$OPTARG" >&2
			exit 1
			;;
	esac
done

echo starting commsec server: $COMMSEC_SERVER $SERVER_ARGS
$BIN_DIR/$COMMSEC_SERVER $SERVER_ARGS &
pid=$!
trap 'kill $pid' EXIT

if [ -n "$TERM_APP" ]; then
	echo starting mavproxy in a new terminal: $EXEC_MAVPROXY
	$TERM_APP $TERM_ARGS "$EXEC_MAVPROXY"
else
	$EXEC_MAVPROXY
fi
